<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OneValet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <style>
    #chat-messages::-webkit-scrollbar { width: 6px; }
    #chat-messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    #message-input { resize: none; field-sizing: content; max-height: 160px; }
    @keyframes pulse-dot { 0%, 80%, 100% { opacity: 0.3; } 40% { opacity: 1; } }
    .typing-dot { animation: pulse-dot 1.4s infinite; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    .md-render p { margin: 0 0 0.2rem 0; }
    .md-render ul, .md-render ol { margin: 0.1rem 0 0.25rem 1.1rem; }
    .md-render code { background: #f3f4f6; padding: 0.05rem 0.3rem; border-radius: 0.25rem; font-size: 0.9em; }
    .md-render pre { background: #111827; color: #f9fafb; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.25rem 0; }
    .md-render pre code { background: transparent; padding: 0; }
    .md-render a { color: #2563eb; text-decoration: underline; }
  </style>
</head>
<body class="h-full bg-gray-50 flex flex-col overflow-hidden">

  <!-- Header -->
  <header class="bg-gray-900 text-white px-6 py-3.5 flex items-center justify-between shrink-0">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center font-bold text-sm">OV</div>
      <span class="text-lg font-semibold tracking-tight">OneValet</span>
    </div>
    <div class="flex items-center gap-1">
      <button onclick="clearChat()" class="p-2 rounded-lg hover:bg-gray-800 transition-colors" title="New chat">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"/>
        </svg>
      </button>
      <a href="/settings" class="p-2 rounded-lg hover:bg-gray-800 transition-colors" title="Settings">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z"/>
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
        </svg>
      </a>
    </div>
  </header>

  <!-- Chat Messages -->
  <main id="chat-messages" class="flex-1 overflow-y-auto px-4 py-6 space-y-4">
    <!-- Setup Banner -->
    <div id="setup-banner" class="hidden">
      <div class="max-w-lg mx-auto mt-12 bg-white rounded-2xl shadow-sm border border-gray-200 p-8 text-center">
        <div class="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
          </svg>
        </div>
        <h2 class="text-xl font-semibold text-gray-900 mb-2">Welcome to OneValet</h2>
        <p class="text-sm text-gray-500 mb-6">Configure your AI provider and database to get started.</p>
        <a href="/settings" class="inline-block bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-6 py-2.5 rounded-lg transition-colors">
          Open Settings
        </a>
      </div>
    </div>
    <!-- Chat Placeholder -->
    <div id="chat-placeholder" class="flex justify-center">
      <p class="text-sm text-gray-400">Send a message to start chatting</p>
    </div>
  </main>

  <!-- Input Bar -->
  <div class="shrink-0 border-t border-gray-200 bg-white px-4 py-3">
    <div class="max-w-3xl mx-auto flex items-end gap-3">
      <textarea
        id="message-input"
        rows="1"
        placeholder="Type a message..."
        class="flex-1 rounded-xl border border-gray-300 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      ></textarea>
      <button
        id="send-btn"
        onclick="sendMessage()"
        class="shrink-0 w-10 h-10 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 text-white rounded-xl flex items-center justify-center transition-colors"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast-container" class="fixed bottom-6 right-6 z-50 space-y-2"></div>

<script>
// ===============================================
// State
// ===============================================
let isStreaming = false;
let appConfigured = false;
let chatHistory = JSON.parse(sessionStorage.getItem('ov_chat') || '[]');

const chatMessages = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');

function saveChatHistory() {
  sessionStorage.setItem('ov_chat', JSON.stringify(chatHistory));
}

function restoreChatHistory() {
  if (chatHistory.length === 0) return;
  const placeholder = document.getElementById('chat-placeholder');
  if (placeholder) placeholder.remove();
  for (const msg of chatHistory) {
    if (msg.role === 'tool') {
      appendToolIndicator(msg.toolName, msg.callId);
      if (msg.result) {
        completeToolIndicator(msg.callId, msg.result);
      }
      continue;
    }
    const wrapper = document.createElement('div');
    wrapper.className = 'max-w-3xl mx-auto flex ' + (msg.role === 'user' ? 'justify-end' : 'justify-start');
    const bubble = document.createElement('div');
    if (msg.role === 'user') {
      bubble.className = 'bg-blue-600 text-white rounded-2xl rounded-br-md px-4 py-2.5 max-w-[75%] text-sm leading-relaxed whitespace-pre-wrap';
    } else if (msg.role === 'error') {
      bubble.className = 'bg-red-50 border border-red-200 text-red-700 rounded-2xl px-4 py-2.5 max-w-[75%] text-sm leading-relaxed';
    } else {
      bubble.className = 'bg-white shadow-sm border border-gray-100 rounded-2xl rounded-bl-md px-4 py-2.5 max-w-[75%] text-sm leading-relaxed whitespace-pre-wrap text-gray-800';
    }
    setBubbleContent(bubble, msg.role, msg.content);
    wrapper.appendChild(bubble);
    chatMessages.appendChild(wrapper);
  }
  scrollToBottom();
}

// ===============================================
// App Status
// ===============================================

async function checkAppStatus() {
  try {
    const resp = await fetch('/api/status');
    const data = await resp.json();
    appConfigured = data.configured;
  } catch (e) {
    appConfigured = false;
  }
  updateUIForConfigState();
}

function updateUIForConfigState() {
  const banner = document.getElementById('setup-banner');
  const placeholder = document.getElementById('chat-placeholder');

  if (!appConfigured) {
    banner.classList.remove('hidden');
    placeholder.classList.add('hidden');
    messageInput.disabled = true;
    messageInput.placeholder = 'Complete setup to start chatting...';
    sendBtn.disabled = true;
  } else {
    banner.classList.add('hidden');
    placeholder.classList.remove('hidden');
    messageInput.disabled = false;
    messageInput.placeholder = 'Type a message...';
    sendBtn.disabled = false;
  }
}

// ===============================================
// Chat
// ===============================================

function appendMessage(role, content, save = true) {
  const placeholder = document.getElementById('chat-placeholder');
  if (placeholder) placeholder.remove();
  const banner = document.getElementById('setup-banner');
  if (banner) banner.classList.add('hidden');

  const wrapper = document.createElement('div');
  wrapper.className = 'max-w-3xl mx-auto flex ' + (role === 'user' ? 'justify-end' : 'justify-start');

  const bubble = document.createElement('div');
  if (role === 'user') {
    bubble.className = 'bg-blue-600 text-white rounded-2xl rounded-br-md px-4 py-2.5 max-w-[75%] text-sm leading-relaxed whitespace-pre-wrap';
  } else if (role === 'error') {
    bubble.className = 'bg-red-50 border border-red-200 text-red-700 rounded-2xl px-4 py-2.5 max-w-[75%] text-sm leading-relaxed';
  } else {
    bubble.className = 'bg-white shadow-sm border border-gray-100 rounded-2xl rounded-bl-md px-4 py-2.5 max-w-[75%] text-sm leading-relaxed whitespace-pre-wrap text-gray-800';
  }
  setBubbleContent(bubble, role, content);

  wrapper.appendChild(bubble);
  chatMessages.appendChild(wrapper);
  scrollToBottom();

  if (save) {
    chatHistory.push({ role, content });
    saveChatHistory();
  }
  return bubble;
}

function appendToolIndicator(toolName, callId) {
  const wrapper = document.createElement('div');
  wrapper.className = 'max-w-3xl mx-auto tool-indicator';
  if (callId) wrapper.dataset.callId = callId;
  const displayName = formatToolName(toolName);

  const indicator = document.createElement('div');
  indicator.className = 'inline-flex items-center gap-2 bg-amber-50 border border-amber-200 rounded-lg px-3 py-1.5 text-xs text-amber-800';
  indicator.innerHTML = `
    <svg class="w-3.5 h-3.5 animate-spin tool-spinner" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
    </svg>
    <svg class="w-3.5 h-3.5 hidden tool-done" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
    </svg>
    <span class="tool-label">Calling <strong>${escapeHtml(displayName)}</strong></span>
  `;

  const detail = document.createElement('div');
  detail.className = 'tool-detail mt-1 hidden text-xs text-gray-600 bg-gray-50 border border-gray-200 rounded-md px-3 py-2 whitespace-pre-wrap';

  wrapper.appendChild(indicator);
  wrapper.appendChild(detail);
  chatMessages.appendChild(wrapper);
  scrollToBottom();
  return wrapper;
}

function renderToolDetail(element, data) {
  if (!element || !data) return;
  const lines = [];
  if (data.kind) lines.push(`Type: ${data.kind}`);
  if (data.status) lines.push(`Status: ${data.status}`);
  if (data.result_preview) lines.push(`Result: ${data.result_preview}`);
  if (Array.isArray(data.tool_trace) && data.tool_trace.length > 0) {
    lines.push('Trace:');
    for (const item of data.tool_trace.slice(0, 5)) {
      const t = item.tool || 'tool';
      const s = item.status || 'ok';
      const summary = item.summary || '';
      lines.push(`- ${t} [${s}] ${summary}`);
    }
  }
  if (lines.length === 0) return;
  element.textContent = lines.join('\n');
  element.classList.remove('hidden');
}

function completeToolIndicator(callId, data = {}) {
  const el = callId
    ? chatMessages.querySelector(`.tool-indicator[data-call-id="${callId}"]`)
    : chatMessages.querySelector('.tool-indicator:not(.done)');
  if (!el) return;
  el.classList.add('done');

  const inner = el.querySelector('div');
  const spinner = inner.querySelector('.tool-spinner');
  const done = inner.querySelector('.tool-done');
  const label = inner.querySelector('.tool-label');
  const detail = el.querySelector('.tool-detail');

  if (spinner) spinner.classList.add('hidden');
  if (done) done.classList.remove('hidden');

  const success = data.success !== false;
  if (success) {
    inner.className = 'inline-flex items-center gap-2 bg-green-50 border border-green-200 rounded-lg px-3 py-1.5 text-xs text-green-700';
    if (label) label.innerHTML = label.innerHTML.replace('Calling', 'Used');
  } else {
    inner.className = 'inline-flex items-center gap-2 bg-red-50 border border-red-200 rounded-lg px-3 py-1.5 text-xs text-red-700';
    if (label) label.innerHTML = label.innerHTML.replace('Calling', 'Failed');
  }

  renderToolDetail(detail, data);
}

function formatToolName(name) {
  return name.replace(/Agent$/i, '').replace(/([a-z])([A-Z])/g, '$1 $2').replace(/_/g, ' ').trim() || name;
}
function showTypingIndicator() {
  const wrapper = document.createElement('div');
  wrapper.id = 'typing-indicator';
  wrapper.className = 'max-w-3xl mx-auto flex justify-start';
  wrapper.innerHTML = `
    <div class="bg-white shadow-sm border border-gray-100 rounded-2xl rounded-bl-md px-4 py-3 flex gap-1.5">
      <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
      <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
      <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
    </div>
  `;
  chatMessages.appendChild(wrapper);
  scrollToBottom();
}

function removeTypingIndicator() {
  const el = document.getElementById('typing-indicator');
  if (el) el.remove();
}

async function sendMessage() {
  const text = messageInput.value.trim();
  if (!text || isStreaming) return;
  if (!appConfigured) {
    showToast('Please configure OneValet first', 'error');
    return;
  }

  isStreaming = true;
  sendBtn.disabled = true;
  messageInput.value = '';

  appendMessage('user', text);
  showTypingIndicator();

  let currentBubble = null;
  let fullText = '';
  let savedAssistant = false;

  try {
    const response = await fetch('/stream', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text }),
    });

    if (!response.ok) {
      removeTypingIndicator();
      appendMessage('error', `Error: ${response.status} ${response.statusText}`);
      return;
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop();

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const payload = line.slice(6).trim();
        if (payload === '[DONE]') continue;

        try {
          const event = JSON.parse(payload);
          handleStreamEvent(event);
        } catch (e) { /* skip malformed */ }
      }
    }
  } catch (err) {
    removeTypingIndicator();
    appendMessage('error', `Connection error: ${err.message}`);
  } finally {
    removeTypingIndicator();
    isStreaming = false;
    sendBtn.disabled = false;
    messageInput.focus();
  }

  function handleStreamEvent(event) {
    switch (event.type) {
      case 'message_start':
        removeTypingIndicator();
        currentBubble = appendMessage('assistant', '', false);
        fullText = '';
        savedAssistant = false;
        break;
      case 'message_chunk':
        if (!currentBubble) {
          removeTypingIndicator();
          currentBubble = appendMessage('assistant', '', false);
          fullText = '';
        }
        const chunk = typeof event.data === 'object' ? (event.data.chunk || event.data.content || '') : event.data;
        fullText += chunk;
        setBubbleContent(currentBubble, "assistant", fullText);
        scrollToBottom();
        break;
      case 'message_end':
        if (fullText && !savedAssistant) {
          chatHistory.push({ role: 'assistant', content: fullText });
          saveChatHistory();
          savedAssistant = true;
        }
        currentBubble = null;
        break;
      case 'tool_call_start': {
        removeTypingIndicator();
        const name = typeof event.data === 'object' ? (event.data.tool_name || event.data.name || 'tool') : event.data;
        const callId = event.data?.call_id || null;
        appendToolIndicator(name, callId);
        chatHistory.push({ role: 'tool', toolName: name, callId: callId, result: null });
        saveChatHistory();
        break;
      }
      case 'tool_call_end':
      case 'tool_result': {
        const callId = event.data?.call_id || null;
        completeToolIndicator(callId, event.data || {});
        for (let i = chatHistory.length - 1; i >= 0; i--) {
          if (chatHistory[i].role === 'tool' && chatHistory[i].callId === callId) {
            chatHistory[i].result = event.data || {};
            break;
          }
        }
        saveChatHistory();
        break;
      }
      case 'state_change':
        break;
      case 'error': {
        removeTypingIndicator();
        const msg = typeof event.data === 'object' ? (event.data.error || event.data.message || JSON.stringify(event.data)) : event.data;
        appendMessage('error', msg);
        break;
      }
    }
  }
}

function scrollToBottom() {
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

messageInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// ===============================================
// Clear Chat
// ===============================================

async function clearChat() {
  chatHistory = [];
  sessionStorage.removeItem('ov_chat');
  // Clear backend session history
  try { await fetch('/api/clear-session', { method: 'POST' }); } catch (e) { /* ignore */ }
  // Remove all messages, re-add placeholder
  chatMessages.innerHTML = `
    <div id="setup-banner" class="hidden"></div>
    <div id="chat-placeholder" class="flex justify-center">
      <p class="text-sm text-gray-400">Send a message to start chatting</p>
    </div>
  `;
  checkAppStatus();
}

// ===============================================
// Utils
// ===============================================

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function renderMarkdown(content) {
  const source = String(content || '');
  const normalized = source
    .replace(/\r\n/g, '\n')
    .replace(/\n{3,}/g, '\n\n')
    .trim();
  if (window.marked && typeof window.marked.parse === 'function') {
    const html = window.marked.parse(normalized, { gfm: true, breaks: false });
    if (window.DOMPurify && typeof window.DOMPurify.sanitize === 'function') {
      return window.DOMPurify.sanitize(html);
    }
    return html;
  }
  return escapeHtml(normalized).replace(/\n/g, '<br>');
}
function setBubbleContent(bubble, role, content) {
  if (!bubble) return;
  if (role === 'assistant') {
    bubble.classList.add('md-render');
    bubble.classList.remove('whitespace-pre-wrap');
    bubble.innerHTML = renderMarkdown(content);
  } else {
    bubble.textContent = content;
  }
}
function showToast(message, type = 'success') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  const bg = type === 'error' ? 'bg-red-600' : 'bg-gray-900';
  toast.className = `${bg} text-white text-sm px-4 py-2.5 rounded-lg shadow-lg transform transition-all duration-300 translate-y-2 opacity-0`;
  toast.textContent = message;
  container.appendChild(toast);
  requestAnimationFrame(() => toast.classList.remove('translate-y-2', 'opacity-0'));
  setTimeout(() => {
    toast.classList.add('translate-y-2', 'opacity-0');
    setTimeout(() => toast.remove(), 300);
  }, 2500);
}

// ===============================================
// Init
// ===============================================
restoreChatHistory();
checkAppStatus();
</script>
</body>
</html>








